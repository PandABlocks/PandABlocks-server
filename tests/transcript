# Simple server test script.  Consists of commands to send and the expected
# response, the test_exchange script validates this.

# First check for out of order return
< *IDN?
< *IDN?
> OK =PandA
> OK =PandA

# Start with the identification exchange
< *IDN?
> OK =PandA

< *IDN?
> OK =PandA

# Simple echo command
< *ECHO this is an echo?
> OK =this is an echo

< *ECHO?
> ERR Character ' ' expected

# The simplest meta-data inquiry.
# Note that the order of the returned values depends on both the internal
# hashtable implementation and the ordering in the config file.
< *BLOCKS?
> !TTLIN 6
> !OUTENC 4
> !CALC 2
> !SRGATE 4
> !PCOMP 4
> !LUT 8
> !TTLOUT 10
> !LVDSOUT 2
> !ADC 8
> !DIV 4
> !INENC 4
> !COUNTER 8
> !ADDER 1
> !PCAP 1
> !POSENC 4
> !LVDSIN 2
> !PGEN 2
> !QDEC 4
> !SEQ 4
> !PULSE 4
> .

# Now we can read and write some I/O fields
< TTLOUT1.VAL=TTLIN3.VAL
> OK

< TTLOUT1.VAL?
> OK =TTLIN3.VAL

< TTLOUT0.VAL=TTLIN0.VAL
< TTLOUT1.VAL=TTLIN1.VAL
< TTLOUT2.VAL=TTLIN2.VAL
< TTLOUT3.VAL=TTLIN3.VAL
< TTLOUT4.VAL=TTLIN4.VAL
< TTLOUT5.VAL=TTLIN5.VAL
< TTLOUT6.VAL=TTLIN0.VAL
< TTLOUT7.VAL=TTLIN1.VAL
< TTLOUT8.VAL=TTLIN2.VAL
< TTLOUT9.VAL=TTLIN3.VAL
< TTLOUT10.VAL=TTLIN3.VAL
> ERR Invalid block number
> OK
> OK
> OK
> OK
> OK
> ERR Mux selector not known
> OK
> OK
> OK
> OK

< TTLOUT0.VAL?
< TTLOUT1.VAL?
< TTLOUT2.VAL?
< TTLOUT3.VAL?
< TTLOUT4.VAL?
< TTLOUT5.VAL?
< TTLOUT7.VAL?
< TTLOUT8.VAL?
< TTLOUT9.VAL?
> ERR Invalid block number
> OK =TTLIN1.VAL
> OK =TTLIN2.VAL
> OK =TTLIN3.VAL
> OK =TTLIN4.VAL
> OK =TTLIN5.VAL
> OK =TTLIN1.VAL
> OK =TTLIN2.VAL
> OK =TTLIN3.VAL

# Now a few top level error responses
< x
> ERR Unknown command

< *IDN?x
> ERR Unexpected text after command

< *x?
> ERR Unknown command

< *x=
> ERR Unknown command

< TTLIN.*=
> ERR Field not writeable


# Testing the parsing of entity names.  As these are quite complex there are a
# lot of error possibilities to work through.

< ?
> ERR No name found

< xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx?
> ERR Name too long

< x?
> ERR No such block

< TTLIN?
> ERR Missing field name

< TTLIN23?
> ERR Invalid block number

< TTLIN2?
> ERR Missing field name

< TTLIN2.*?
> ERR Block number not allowed

< TTLIN2.x?
> ERR No such field

< TTLIN.VAL?
> ERR Missing block number

< TTLIN.VAL.?
> ERR Missing block number

< TTLIN1.VAL.?
> ERR No name found

< TTLIN2.VAL.*?
> ERR Block number not allowed

< *IDN<
< 123
<
> ERR Not a table

< TTLIN2.VAL<
< 123
<
> ERR Field is not a table

< TTLIN.*?
> !VAL 0 bit_out
> !TERM 1 param enum
> .

< TTLIN2.VAL=x
> ERR Field not writeable

< TTLIN2.VAL=0
> ERR Field not writeable

< TTLIN2.TERM.RAW=0
> OK

< TTLIN2.TERM?
> OK =High-Z

< TTLIN2.TERM.LABELS?
> !0 High-Z
> !1 50-Ohm
> .

< TTLIN2.TERM=50-Ohm
> OK

< TTLIN2.TERM.RAW?
< TTLIN2.TERM?
> OK =1
> OK =50-Ohm

< TTLIN2.TERM=blah
> ERR Label not found

< INENC3.BITS=33
> OK

< INENC3.BITS?
> OK =33

< INENC3.BITS=64
> ERR Number out of range

# Writing a value

< INENC1.SETP=23
> OK

# Unimplemented functionality

< PCOMP2.TABLE<
< 1 2 3 4 5 6 7 8
< 9
<
> ERR block.field< not implemented yet

< PCOMP2.TABLE<B2
< 1234567
> ERR block.field< not implemented yet

< PCOMP2.TABLE<<
< 1 2 3 4 5 6 7 8
< 9
<
> ERR block.field< not implemented yet

< SEQ2.TABLE<
< 1 2 3 4 5 6 7 8
< 9
<
> OK

< SEQ2.TABLE<B2
< 1234567
> OK

< SEQ2.TABLE<<
< 1 2 3 4 5 6 7 8
< 9
<
> OK

< SEQ2.TABLE?
> !875770417
> !171390517
> !1
> !2
> !3
> !4
> !5
> !6
> !7
> !8
> !9
> .


< TTLIN.VAL.*?
> !CAPTURE_INDEX
> !CAPTURE
> .

< DIV.DIVISOR.*?
> !MAX
> .

< DIV1.DIVISOR.MAX?
> OK =4294967295

< INENC1.BITS.MAX?
> OK =63

< TTLIN2.TERM.ENUMS?
> ERR No such attribute

< TTLIN2.TERM.ENUMS=x
> ERR No such attribute


# There's a surprising delay on the block operations.  Try doing them all in one
# go instead.
< PCOMP2.TABLE<
< 1 2 3 4 5 6 7 8
< 9
<
< PCOMP2.TABLE<B2
< 1234567
< PCOMP2.TABLE<<
< 1 2 3 4 5 6 7 8
< 9
<
> ERR block.field< not implemented yet
> ERR block.field< not implemented yet
> ERR block.field< not implemented yet

# Testing position fields
< QDEC.SETP.*?
> !UNITS
> !OFFSET
> !SCALE
> !RAW
> .


< QDEC1.SETP.SCALE=0.1
> OK

< QDEC1.SETP.OFFSET=100.3
> OK

< QDEC1.SETP=123.45
> OK

< QDEC1.SETP?
> OK =123.5

< QDEC1.SETP.RAW?
> OK =232

< QDEC1.SETP.SCALE?
> OK =0.1

< QDEC1.SETP.OFFSET?
> OK =100.3

< QDEC1.SETP.UNITS=mm
> OK

< QDEC1.SETP.UNITS?
> OK =mm

# LUT
< LUT.*?
> !FUNC 6 param lut
> !INPB 1 param bit_mux
> !INPC 2 param bit_mux
> !INPA 0 param bit_mux
> !VAL 5 bit_out
> !INPD 3 param bit_mux
> !INPE 4 param bit_mux
> .

< LUT.FUNC.*?
> !RAW
> .

< LUT1.FUNC=0x123
> OK

< LUT1.FUNC?
> OK =0x123

< LUT1.FUNC.RAW?
> OK =291

< LUT1.FUNC=A&B|C=>D^E
> OK

< LUT1.FUNC=A&F
> ERR Invalid token

< LUT1.FUNC?
> OK =A&B|C=>D^E

# Description fields
< *DESC.TTLIN?
> OK =TTL input

< *DESC.TTLIN.TERM?
> OK =Select TTL input termination

# Capture and capture index
< *CAPTURE=
> OK

< *CAPTURE?
> .

< TTLIN1.VAL.CAPTURE?
> OK =0

< TTLIN1.VAL.CAPTURE=1
> OK

< *CAPTURE?
> !*BITS0
> .

< TTLIN1.VAL.CAPTURE_INDEX?
> OK =0:0

< INENC2.ENC_POSN.CAPTURE=1
> OK

< *CAPTURE?
> !INENC2.ENC_POSN
> !*BITS0
> .

< TTLIN1.VAL.CAPTURE_INDEX?
> OK =1:0

< TTLIN2.VAL.CAPTURE=1
> OK

< TTLIN2.VAL.CAPTURE_INDEX?
> OK =1:1

< INENC3.ENC_POSN.CAPTURE_INDEX?
> OK =

# Change reporting
< *CHANGES.CONFIG=
> OK

< *CHANGES.CONFIG?
> .

< *CHANGES.ATTR=
> OK

< *CHANGES.ATTR?
> .

< INENC2.ENC_POSN.CAPTURE=1
> OK

< *CHANGES.ATTR?
> !INENC2.ENC_POSN.CAPTURE=1
> .

# Pulse time
< PULSE1.DELAY.UNITS=s
> OK

< PULSE1.DELAY=10
> OK

< PULSE1.DELAY.UNITS=ms
< PULSE1.DELAY?
< PULSE1.DELAY.UNITS=s
> OK
> OK =10000
> OK

< PULSE1.DELAY?
> OK =10

< PULSE1.DELAY=2251799
> OK

< PULSE1.DELAY=2251800
> ERR Time setting out of range

# Table support
< SEQ.TABLE.*?
> !MAX_LENGTH
> !B
> !LENGTH
> !FIELDS
> .

< SEQ1.TABLE.FIELDS?
> !11:0    NREPEATS
> !15:12   INPUT_MASK
> !19:16   TRIGGER_MASK
> !25:20   OUT_PH_A
> !31:26   OUT_PH_B
> !47:32   TIME_PH_A
> !63:48   TIME_PH_B
> .

< SEQ1.TABLE.MAX_LENGTH?
> OK =2048

< SEQ1.TABLE<
<
> OK

< SEQ1.TABLE.LENGTH?
> OK =0

< SEQ1.TABLE<
< 1 2 3 4
<
> OK

< SEQ1.TABLE.LENGTH?
> OK =4

< SEQ1.TABLE.B?
> !AQAAAAIAAAADAAAABAAAAA==
> .

# Somewhat more challenging test taken from wikipedia.
< SEQ1.TABLE<B20
< Man is distinguished, not only by his reason, but by this singular passion from
> OK

< SEQ1.TABLE.LENGTH?
> OK =20

< SEQ1.TABLE.B?
> !TWFuIGlzIGRpc3Rpbmd1aXNoZWQsIG5vdCBvbmx5IGJ5IGhpcyByZWFzb24sIGJ1dCBieSB0aGlz
> !IHNpbmd1bGFyIHBhc3Npb24gZnJvbQo=
> .
